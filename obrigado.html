<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Obrigada!</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #ffffff;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
    }
  </style>
  
<!-- Meta Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '773719858512638'); // USE O MESMO ID EM TODO LUGAR
  fbq('track', 'Purchase', {
    value: 67.90,
    currency: 'BRL'
  });
</script>

<noscript>
  <img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=773719858512638&ev=Purchase&cd[value]=19.90&cd[currency]=BRL&noscript=1"/>
</noscript>
<!-- End Meta Pixel Code -->

</head>
<body>
  <!-- Substitua a URL abaixo pela sua imagem -->
  <img src="thanks.png" alt="Imagem da Página" />
</body>
  <script>
  async function sendPurchaseEvent() {
    const params = new URLSearchParams(window.location.search);

    // Coleta de parâmetros (com aliases em PT)
    const email = params.get("email") || "";
    const phone = params.get("phone") || "";
    const cityRaw = params.get("city") || params.get("cidade") || "";
    const stateRaw = params.get("state") || params.get("estado") || "";

    // Normalização + hash dos PII
    const hashedEmail = email ? await sha256(normalizePII(email)) : "";
    const hashedPhone = phone ? await sha256(normalizePII(phone)) : "";
    const hashedCity  = cityRaw ? await sha256(normalizePII(cityRaw)) : "";
    const hashedState = stateRaw ? await sha256(normalizePII(stateRaw)) : "";

    // fb cookies
    const fbp = getCookie('_fbp');
    const fbc = getCookie('_fbc');

    // Monta o payload da CAPI
    const body = {
      data: [
        {
          event_name: "Purchase",
          event_time: Math.floor(Date.now() / 1000),
          action_source: "website",
          user_data: {
            em: hashedEmail,            // email (SHA256)
            ph: hashedPhone,            // phone (SHA256)
            ct: hashedCity,             // city (SHA256)
            st: hashedState,            // state/UF (SHA256)
            client_ip_address: "{{auto}}",
            client_user_agent: navigator.userAgent,
            fbp: fbp || undefined,
            fbc: fbc || undefined
          },
          // (Opcional) Se quiser ver cidade/estado nos relatórios/Debug,
          // você pode mandar também em custom_data (sem hash).
          custom_data: {
            currency: "BRL",
            value: 19.90,
            city: cityRaw || undefined,
            state: stateRaw || undefined
          }
        }
      ]
    };

    fetch("https://graph.facebook.com/v17.0/SEU_PIXEL_ID/events?access_token=SEU_TOKEN_API", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
  }

  // Remove acentos, espaços duplicados, põe em lowercase
  function normalizePII(text) {
    return text
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove acentos
      .replace(/\s+/g, ' '); // colapsa espaços
  }

  async function sha256(text) {
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  }

  // Executa quando a página carrega
  sendPurchaseEvent();
</script>

</html>
